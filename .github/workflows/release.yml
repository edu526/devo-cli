name: Release

on:
  push:
    branches:
      - main
    paths:
      - 'cli_tool/**'
      - 'tests/**'
      - 'scripts/**'
      - 'devo.spec'
      - 'setup.py'
      - 'pyproject.toml'
      - 'requirements.txt'
      - '.github/workflows/release.yml'
      - '.pre-commit-config.yaml'
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  test:
    name: Run Tests
    uses: ./.github/workflows/test-reusable.yml
    with:
      python-version: '3.12'

  check-version:
    name: Check next version (dry-run)
    runs-on: ubuntu-latest
    needs: test
    outputs:
      should-release: ${{ steps.check.outputs.should-release }}
      next-version: ${{ steps.check.outputs.next-version }}
      next-tag: ${{ steps.check.outputs.next-tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install semantic-release
        run: pip install python-semantic-release

      - name: Check next version (dry-run)
        id: check
        run: |
          echo "ğŸ” Checking if new release is needed..."

          # Dry-run to get next version without creating anything
          NEXT_VERSION=$(semantic-release version --print 2>/dev/null || echo "")

          if [ -n "$NEXT_VERSION" ]; then
            echo "should-release=true" >> $GITHUB_OUTPUT
            echo "next-version=${NEXT_VERSION}" >> $GITHUB_OUTPUT
            echo "next-tag=v${NEXT_VERSION}" >> $GITHUB_OUTPUT
            echo "âœ… New version will be: v${NEXT_VERSION}"
          else
            echo "should-release=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No new release needed"
          fi

  build-binaries:
    name: Build ${{ matrix.platform }}-${{ matrix.arch }}
    runs-on: ${{ matrix.os }}
    needs: check-version
    if: needs.check-version.outputs.should-release == 'true'
    strategy:
      matrix:
        include:
          # Linux
          - os: ubuntu-latest
            platform: linux
            arch: amd64
            build_script: bash scripts/build.sh --ci --release

          # macOS Intel
          - os: macos-latest
            platform: darwin
            arch: amd64
            build_script: bash scripts/build.sh --ci --release

          # macOS Apple Silicon
          - os: macos-14
            platform: darwin
            arch: arm64
            build_script: bash scripts/build.sh --ci --release

          # Windows
          - os: windows-latest
            platform: windows
            arch: amd64
            build_script: |
              scripts\build-windows.bat
              scripts\package-windows.ps1

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Create local tag for version detection
        run: |
          TAG="v${{ needs.check-version.outputs.next-version }}"
          echo "ğŸ“ Checking if tag ${TAG} exists..."

          # Check if tag already exists (locally or remotely)
          if git rev-parse "${TAG}" >/dev/null 2>&1; then
            echo "âš ï¸  Tag ${TAG} already exists, skipping creation"
          else
            echo "Creating local tag ${TAG} for setuptools_scm..."
            git tag "${TAG}"
            echo "âœ… Tag created locally"
          fi

          git describe --tags

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Build binary
        env:
          RELEASE_VERSION: ${{ needs.check-version.outputs.next-tag }}
          FORCE_ARCH: ${{ matrix.arch }}
        run: ${{ matrix.build_script }}

      - name: Test binary (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          echo "ğŸ§ª Testing binary..."
          chmod +x dist/devo 2>/dev/null || true
          BINARY_VERSION=$(./dist/devo --version 2>&1 | head -1 || echo "ERROR")
          echo "Binary version output: $BINARY_VERSION"

          if [ "$BINARY_VERSION" = "ERROR" ] || [ -z "$BINARY_VERSION" ]; then
            echo "âŒ Binary test failed - no version output"
            exit 1
          fi

          echo "âœ… Binary works! Version: $BINARY_VERSION"

      - name: Test binary (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "ğŸ§ª Testing binary..."
          try {
            $output = & "dist\devo\devo.exe" --version 2>&1 | Select-Object -First 1
            Write-Host "Binary version output: $output"

            if ([string]::IsNullOrWhiteSpace($output)) {
              Write-Host "âŒ Binary test failed - no version output"
              exit 1
            }

            Write-Host "âœ… Binary works! Version: $output"
          } catch {
            Write-Host "âŒ Binary test failed with error: $_"
            exit 1
          }

      - name: Check binary size (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          BINARY_SIZE=$(stat -f%z dist/devo 2>/dev/null || stat -c%s dist/devo)
          BINARY_SIZE_MB=$((BINARY_SIZE / 1024 / 1024))
          echo "Binary size: ${BINARY_SIZE_MB}MB"

          if [ $BINARY_SIZE_MB -lt 10 ]; then
            echo "âš ï¸  Warning: Binary seems too small (${BINARY_SIZE_MB}MB)"
          fi

      - name: Check binary size (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $size = (Get-Item "dist\devo\devo.exe").Length
          $sizeMB = [math]::Round($size / 1MB, 2)
          Write-Host "Binary size: ${sizeMB}MB"

          if ($sizeMB -lt 10) {
            Write-Host "âš ï¸  Warning: Binary seems too small (${sizeMB}MB)"
          }

      - name: Upload binary artifacts
        uses: actions/upload-artifact@v4
        with:
          name: devo-${{ matrix.platform }}-${{ matrix.arch }}
          path: |
            release/**/*
            dist/devo*
          if-no-files-found: error

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [check-version, build-binaries]
    if: needs.check-version.outputs.should-release == 'true'
    outputs:
      released: ${{ steps.release.outputs.released }}
      tag: ${{ steps.release.outputs.tag }}
      version: ${{ steps.release.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install semantic-release
        run: pip install python-semantic-release

      - name: Create release
        id: release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸš€ Creating release for version ${{ needs.check-version.outputs.next-version }}..."

          # Run semantic-release to create tag, update changelog, and create GitHub release
          semantic-release version
          semantic-release publish

          # Push changes
          git push --follow-tags origin main

          echo "released=true" >> $GITHUB_OUTPUT
          echo "tag=${{ needs.check-version.outputs.next-tag }}" >> $GITHUB_OUTPUT
          echo "version=${{ needs.check-version.outputs.next-version }}" >> $GITHUB_OUTPUT
          echo "âœ… Release created successfully"

  upload-assets:
    name: Upload Release Assets
    runs-on: ubuntu-latest
    needs: [check-version, build-binaries, create-release]
    if: needs.check-version.outputs.should-release == 'true'

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release-assets

          echo "ğŸ“¦ Preparing binaries for release..."

          # Copy Linux binary (single file)
          find artifacts/devo-linux-amd64/release -name "devo-linux-amd64" -type f -exec cp -v {} release-assets/ \;

          # Copy macOS Intel binary (single file)
          find artifacts/devo-darwin-amd64/release -name "devo-darwin-amd64" -type f -exec cp -v {} release-assets/ \;

          # Copy macOS ARM binary (single file)
          find artifacts/devo-darwin-arm64/release -name "devo-darwin-arm64" -type f -exec cp -v {} release-assets/ \;

          # Copy Windows ZIP (onedir package)
          find artifacts/devo-windows-amd64/release -name "*.zip" -type f -exec cp -v {} release-assets/ \;

          # Generate checksums
          cd release-assets
          sha256sum * > SHA256SUMS 2>/dev/null || shasum -a 256 * > SHA256SUMS
          echo ""
          echo "âœ… Release assets ready:"
          ls -lh
          cat SHA256SUMS
          cd ..

      - name: Upload assets to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.check-version.outputs.next-tag }}"
          echo "Uploading assets to release ${TAG}..."

          # Upload each asset
          for file in release-assets/*; do
            echo "Uploading $(basename $file)..."
            gh release upload "${TAG}" "$file" --clobber --repo ${{ github.repository }}
          done

          echo "âœ… All assets uploaded successfully"

  notify-telegram:
    name: Notify Telegram
    runs-on: ubuntu-latest
    needs: [test, check-version, build-binaries, create-release, upload-assets]
    if: always()

    steps:
      - name: Determine overall status
        id: status
        run: |
          # Check if any job failed or was cancelled
          if [ "${{ needs.test.result }}" == "failure" ] || \
             [ "${{ needs.check-version.result }}" == "failure" ] || \
             [ "${{ needs.build-binaries.result }}" == "failure" ] || \
             [ "${{ needs.create-release.result }}" == "failure" ] || \
             [ "${{ needs.upload-assets.result }}" == "failure" ] || \
             [ "${{ needs.test.result }}" == "cancelled" ] || \
             [ "${{ needs.check-version.result }}" == "cancelled" ] || \
             [ "${{ needs.build-binaries.result }}" == "cancelled" ] || \
             [ "${{ needs.create-release.result }}" == "cancelled" ] || \
             [ "${{ needs.upload-assets.result }}" == "cancelled" ]; then
            echo "overall=failure" >> $GITHUB_OUTPUT
          elif [ "${{ needs.check-version.outputs.should-release }}" != "true" ]; then
            echo "overall=no-release" >> $GITHUB_OUTPUT
          else
            echo "overall=success" >> $GITHUB_OUTPUT
          fi

      - name: Send success notification
        if: steps.status.outputs.overall == 'success'
        continue-on-error: true
        uses: appleboy/telegram-action@master
        with:
          to: ${{ vars.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          disable_web_page_preview: false
          message: |
            ğŸ‰ *Devo CLI Release SUCCESS*

            ğŸ“¦ Version: `${{ needs.check-version.outputs.next-version }}`
            ğŸ·ï¸ Tag: `${{ needs.check-version.outputs.next-tag }}`
            ğŸ“‚ Repository: ${{ github.repository }}
            ğŸ‘¤ Author: ${{ github.actor }}

            âœ… All steps completed successfully

            ğŸ”— [View Release](${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ needs.check-version.outputs.next-tag }})
            ğŸ”— [View Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

      - name: Send failure notification
        if: steps.status.outputs.overall == 'failure'
        continue-on-error: true
        uses: appleboy/telegram-action@master
        with:
          to: ${{ vars.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            ğŸš¨ *Devo CLI Release FAILED*

            âŒ Release process failed on branch `${{ github.ref_name }}`
            ğŸ‘¤ Author: ${{ github.actor }}
            Commit: `${{ github.sha }}`

            Step Results:
            â€¢ Tests: ${{ needs.test.result }}
            â€¢ Check Version: ${{ needs.check-version.result }}
            â€¢ Build Binaries: ${{ needs.build-binaries.result }}
            â€¢ Create Release: ${{ needs.create-release.result }}
            â€¢ Upload Assets: ${{ needs.upload-assets.result }}

            ğŸ”— [View Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

      - name: Send no-release notification
        if: steps.status.outputs.overall == 'no-release'
        continue-on-error: true
        uses: appleboy/telegram-action@master
        with:
          to: ${{ vars.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            â„¹ï¸ *Devo CLI - No Release Needed*

            Tests passed but no new release was created.

            Branch: `${{ github.ref_name }}`
            ğŸ‘¤ Author: ${{ github.actor }}

            This means there were no conventional commits since the last release.

            ğŸ”— [View Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
