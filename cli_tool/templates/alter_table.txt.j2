-- Description: Brief description of the table changes
-- Ticket: [TICKET-NUMBER]
-- Author: [YOUR_NAME]
-- Date: [YYYY-MM-DD]

-- Safe alter table for PostgreSQL
DO $$
BEGIN
    -- Add column if it doesn't exist
    IF NOT EXISTS (
        SELECT 1
        FROM information_schema.columns
        WHERE table_schema = '{schema_name}'
        AND table_name = '{table_name}'
        AND column_name = '{column_name}'
    ) THEN
        ALTER TABLE {schema_name}."{table_name}"
        ADD COLUMN "{column_name}" {data_type} {constraints};
    END IF;

    -- Example of adding constraints if they don't exist
 END
$$;

DO $$
BEGIN
    -- Verify if the constraint doesn't exist
    IF NOT EXISTS (
        SELECT 1
        FROM information_schema.table_constraints
        WHERE table_schema = '{schema_name}'
          AND table_name = '{table_name}'
          AND constraint_name = '{constraint_name}'
    ) THEN
        -- Validate data before adding constraint
        IF NOT EXISTS (
            SELECT 1
            FROM {schema_name}."{table_name}" t
            LEFT JOIN {schema_name}."{referenced_table}" r ON t."{foreign_key_column}" = r."{referenced_column}"
            WHERE r."{referenced_column}" IS NULL AND t."{foreign_key_column}" IS NOT NULL
        ) THEN
            ALTER TABLE {schema_name}."{table_name}"
            ADD CONSTRAINT "{constraint_name}"
            FOREIGN KEY ("{foreign_key_column}")
            REFERENCES {schema_name}."{referenced_table}" ("{referenced_column}")
            ON DELETE {delete_action}
            ON UPDATE {update_action};
        ELSE
            RAISE EXCEPTION 'Data validation failed: orphaned records found in table {table_name}';
        END IF;
    ELSE
        RAISE NOTICE 'Constraint {constraint_name} already exists';
    END IF;
END
$$;

-- Example usage:
-- Table
/*
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1
        FROM information_schema.columns
        WHERE table_schema = 'surveys'
        AND table_name = 'responses'
        AND column_name = 'last_modified_date'
    ) THEN
        ALTER TABLE surveys."responses"
        ADD COLUMN "last_modified_date" timestamp with time zone DEFAULT CURRENT_TIMESTAMP;
    END IF;
END
$$;
*/
--CONSTRAINT
/*DO $$
BEGIN
    -- Verify if the constraint doesn't exist before adding it
    IF NOT EXISTS (
        SELECT 1
        FROM information_schema.table_constraints
        WHERE table_schema = 'dbo'
          AND table_name = 'Vehicles'
          AND constraint_name = 'fk_vehicles_rideproviders'
    ) THEN
        -- Validate data before adding constraint
        IF NOT EXISTS (
            SELECT 1
            FROM dbo."Vehicles" v
            LEFT JOIN dbo."RideProviders" rp ON v."RideProviderId" = rp."Id"
            WHERE rp."Id" IS NULL AND v."RideProviderId" IS NOT NULL
        ) THEN
            ALTER TABLE dbo."Vehicles"
            ADD CONSTRAINT "fk_vehicles_rideproviders"
            FOREIGN KEY ("RideProviderId")
            REFERENCES dbo."RideProviders" ("Id")
            ON DELETE RESTRICT
            ON UPDATE CASCADE;
        ELSE
            RAISE NOTICE 'Data validation failed: orphans found in table';
        END IF;
    ELSE
            RAISE NOTICE 'CONSTRAINT already exists';
    END IF;
END
$$;*/

-- Notes:
-- 1. File naming convention: V{CURRENT_DATE}.{TASK_ID}__{DESCRIPTION}.sql
-- 2. Use IF NOT EXISTS checks to make changes idempotent
-- 3. Always include schema name
-- 4. Use double quotes for case-sensitive identifiers
-- 5. Wrap multiple alterations in a DO block for atomic execution
-- 6. Consider impact on existing data when adding constraints
-- 7. For large tables, consider maintenance window requirements